<html><head>
  <title>Truthy Graphy</title>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.3.0/math.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/picnic/6.1.2/picnic.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.5.1/nouislider.min.css">
  <style>
    .container {
      width: 702px;
      margin: 0 auto;
    }

    body {
      padding-top: 10px;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      color: #333;
    }

    .title {
      font-family: "Raleway", "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 300%;
      letter-spacing: 4px;
      font-weight: 100;
      color: #000064;
    }

    /* Footer */
    .footer {
      margin-top: 50px;
      text-align: center;
      color: #AAAAAA;
      font-size: .8em;
    }

    .footer-container {
      width: 200px;
      margin-left: auto;
      margin-right: auto;
      font-weight: 200;
      margin-bottom: 40px;
    }

    .footer hr {
      border: 0;
      border-bottom: 1px dashed #ccc;
      background: #999;
      margin: 2px;
    }

    .footer a, .footer a:visited, .footer a:hover {
      color: #000064;
    }

    #canvas {
      border: 1px solid #ccc;
    }

    .radio-fieldset {
      margin: 7px 0px;
    }

    /*#fuzzy-slider {
      margin-bottom: 30px;
    }*/
  </style>
</head><body>

<div class="container">
  <article class="card">
    <header>
      <h1 class="title">Truthy Graphy</h1>
    </header>
    <footer>
      <div class="flex two">
        <div>
          <label>
            <span>Equation</span>
            <input type="equation" id="equation" placeholder="y^2 = x^3 - x + 1">
          </label>

          <fieldset class="radio-fieldset">
            <label>
              <input type="radio" name="graph-type" value="truthy" checked>
              <span class="checkable">Graph Truthy</span>
            </label>

            <label>
              <input type="radio" name="graph-type" value="boolean">
              <span class="checkable">Graph Boolean</span>
            </label>
          </fieldset>

          <label>
            <span class="checkable">Fuzzy Level</span>
            <div id="fuzzy-slider"></div>
          </label>
        </div>

        <!-- <div>
          <article class="card">
            <header>
              <h5>Examples</h5>
            </header>
            <footer>
              <a href="#">y=x^2</a>
              <span>y=x^3-2x</span>
              <span>y=sin(3x)</span>
              <span>x = y^2 - 2</span>
              <span>x^2/2+y^2=3</span>
            </footer>
          </article>
        </div> -->
      </div>


    </footer>
  </article>

  <canvas id="canvas" width="700" height="700">
    Your browser does not support HTML5 Canvas.
  </canvas>
</div>

<div class="footer">
  <div class="footer-container">
      <span>
        <a href="https://github.com/calebmadrigal/truthy-graphy">View on Github</a>
      </span>
    <hr />
    <span>Project by <a href="http://calebmadrigal.com">Caleb Madrigal</a></span>
  </div>
</div>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.5.1/nouislider.min.js"></script>
<script type="text/javascript">

////////////////////////////////////////////////////////////////////////////////////  Math functions

// Returns a function maps from the inRange to the outRange
var makeLinearMapper = function(inRange, outRange, intOut) {
  var inDelta = inRange[1] - inRange[0];
  var outDelta = outRange[1] - outRange[0];
  // y = mx + b (m = slope, b = y-intersect)
  var m = (outDelta / inDelta);
  // To find b: b = y - mx
  // Just plug in first item of each range
  var b = outRange[0] - m * inRange[0];

  if (intOut) {
    var linearMapper = function(val) {
      return Math.round(m * val + b);
    }
  }
  else {
    var linearMapper = function(val) {
      return m * val + b;
    }
  }

  return linearMapper;
};

var parseEquationString = function(eq_str) {
  var split_result = eq_str.split("=");
  if (split_result.length != 2) {
    return null;
  }

  var left_eq = math.eval('f(x, y) = ' + split_result[0], {});
  var right_eq = math.eval('f(x, y) = ' + split_result[1], {});
  var error_func = function (x, y) { return Math.abs(left_eq(x, y) - right_eq(x, y)); }

  return error_func;
}

////////////////////////////////////////////////////////////////////////////////////// Display stuff

var makeColorMapper = function(minInput, maxInput) {
    var colorChannelRange = [0, 255];
    var colorMapper = makeLinearMapper([minInput, maxInput], colorChannelRange, true);

    var mapper = function(val) {
        var colorVal = colorMapper(val);
        var rgbVals = [colorVal, colorVal, 100];
        return rgbVals;
    };

    return mapper;
};

var calculateFuncForWindow = function(func, xMin, xMax, yMin, yMax) {
  var canvas = document.getElementById('canvas');
  var context = canvas.getContext('2d');
  var canvasWidth = context.canvas.width;
  var canvasHeight = context.canvas.height;

  var pixel_to_x_mapper = makeLinearMapper([0, canvasWidth], [xMin, xMax], false);
  var pixel_to_y_mapper = makeLinearMapper([canvasHeight, 0], [yMin, yMax], false);

  var minValue = 9999999;
  var maxValue = -9999999;
  var pixelValues = new Array(canvasWidth * canvasHeight);

  // Calculate values for each pixel, and find the min and max values
  for (var pixelX = 0; pixelX < canvasWidth; pixelX++) {
    for (var pixelY = 0; pixelY < canvasHeight; pixelY++) {
      var x = pixel_to_x_mapper(pixelX);
      var y = pixel_to_y_mapper(pixelY);
      var result = func(x, y);
      if (result > maxValue) {
        maxValue = result;
      }
      if (result < minValue) {
        minValue = result;
      }

      pixelValues[(pixelY * canvasWidth) + pixelX] = result;
    }
  }

  return {'pixelValues': pixelValues, 'max': maxValue, 'min': minValue};
}

var displayTruthyGraph = function(pixelValues, minValue, maxValue, fuzzyValue) {
  var canvas = document.getElementById('canvas');
  var context = canvas.getContext('2d');
  var canvasWidth = context.canvas.width;
  var canvasHeight = context.canvas.height;
  var imageData = context.createImageData(canvasWidth, canvasHeight);
  var pixelData = imageData.data;

  // Function to modify the value to make the graph look more interesting
  // We do this because the value is a measure of error, but we want more error
  // to look like a more intense value on the graph
  var valueModifier = function (value) {
    return Math.pow(maxValue - value, fuzzyValue);
  }

  // Determine the color scale based on the min and max values
  // TODO: make color mapper go from minValue to maxValue
  var colorMapper = makeColorMapper(valueModifier(maxValue), valueModifier(minValue));

  // Set the color for each pixel based on the values
  for (var x = 0; x < canvasWidth; x++) {
    for (var y = 0; y < canvasHeight; y++) {
      var value = pixelValues[y * canvasWidth + x];
      color = colorMapper(valueModifier(value));

      // Set pixel color channels
      var pixelOffset = (canvasWidth * y + x) * 4;
      pixelData[pixelOffset] = color[0];     // red
      pixelData[pixelOffset + 1] = color[1]; // green
      pixelData[pixelOffset + 2] = color[2]; // blue
      pixelData[pixelOffset + 3] = 255;      // alpha
    }
  }

  context.putImageData(imageData, 0, 0);
};

var displayBinaryGraph = function(pixelValues, truthThreshold) {
  var canvas = document.getElementById('canvas');
  var context = canvas.getContext('2d');
  var canvasWidth = context.canvas.width;
  var canvasHeight = context.canvas.height;
  var imageData = context.createImageData(canvasWidth, canvasHeight);
  var pixelData = imageData.data;

  // Set the color for each pixel based on the values
  for (var x = 0; x < canvasWidth; x++) {
    for (var y = 0; y < canvasHeight; y++) {
      var value = pixelValues[y * canvasWidth + x];
      if (value <= truthThreshold) {
        color = [0, 0, 0];  // black
      }
      else {
        color = [255, 255, 255];  // white
      }

      // Set pixel color channels
      var pixelOffset = (canvasWidth * y + x) * 4;
      pixelData[pixelOffset] = color[0];     // red
      pixelData[pixelOffset + 1] = color[1]; // green
      pixelData[pixelOffset + 2] = color[2]; // blue
      pixelData[pixelOffset + 3] = 255;      // alpha
    }
  }

  context.putImageData(imageData, 0, 0);
};

/////////////////////////////////////////////////////////////////////////////////////////////// Main

var graph_truthy = true;
var fuzzy_value = 20;

var equation_input = document.querySelector('#equation');
var radios = document.querySelectorAll('input[type=radio][name="graph-type"]');
var fuzzy_slider = document.getElementById('fuzzy-slider');

var getInputAndGraph = function() {
  try {
    var equationToGraph = parseEquationString(equation_input.value);
  }
  catch(err) {
    return;
  }

  if (equationToGraph) {
    var xMin = -3;
    var xMax = 3;
    var yMin = -3;
    var yMax = 3;

    var pixelValues = calculateFuncForWindow(equationToGraph, xMin, xMax, yMin, yMax);

    if (graph_truthy) {
      displayTruthyGraph(pixelValues['pixelValues'], pixelValues['min'], pixelValues['max'], fuzzy_value);
    } else {
      displayBinaryGraph(pixelValues['pixelValues'], 0.02);
    }
  }
}

noUiSlider.create(fuzzy_slider, {
	start: [200 - 20],
	range: { min: 1, max: 200 },
  step: 1,
  connect: false,
  // pips: { // Show a scale with the slider
	// 	mode: 'count',
	// 	values: 8,
  //   density: 2
	// }
});

fuzzy_slider.noUiSlider.on('update', function(value) {
  fuzzy_value = 201 - parseInt(value);
	getInputAndGraph();
});

function graphTruthyChangeHandler(event) {
   if ( this.value === 'truthy' ) {
     graph_truthy = true;
   } else {
     graph_truthy = false;
   }
   getInputAndGraph();
}

Array.prototype.forEach.call(radios, function(radio) {
   radio.addEventListener('change', graphTruthyChangeHandler);
});

equation_input.addEventListener('input', getInputAndGraph);

// Initial conditions
equation_input.value = "y^2=x^3 - x + 1";
getInputAndGraph();

</script>

</body></html>
