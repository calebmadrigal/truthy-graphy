<html><head>
  <title>Truthy Graphy</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.0/jquery-ui.min.css">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.3.0/math.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.0/jquery-ui.min.js"></script>
  <style>
    html, body {
      width:  100%;
      height: 100%;
      margin: 0px;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      color: #333;
    }

    #main {
      position:relative;
      height: 100%;
      width:100%;
    }

    #controls {
      width: 250px;
      z-index: 10;  /* <- higher than your canvases if it needs to go on top */
      position: absolute;
      /*border: 1px solid black;*/
      left: 0;
      top: 0;
      background-color: #fff;
      background-color: rgba(255,255,255,0.5);
      padding: 10px;
      color: white;
      font-weight: lighter;
      letter-spacing: 1px;
    }

    .title {
      font-family: "Raleway", "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 150%;
      letter-spacing: 4px;
      font-weight: 100;
      color: white;
      margin: 5px 0px;
      text-align: center;
    }

    #footer-info {
      font-size: 0.7em;
    }

    #equation {
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      font-size: 16px;
      width: 100%;
      margin-bottom: 5px;
    }

    #canvas {
      border: 1px solid #ccc;
      cursor: move;
      float: left;
      width: 100%;
      height:100%;
      position:absolute;
    }

    .zoom-btn {
      padding: 5px 10px;
    }

    fieldset {
      -moz-border-radius:5px;
      border-radius: 5px;
      -webkit-border-radius: 5px; //edit :D
    }
  </style>
</head><body>

<div id="main">
  <div id="controls">
    <h1 class="title">Truthy Graphy</h1>
    <div>
      <input type="equation" id="equation" placeholder="y^2 = x^3 - x + 1">

      <fieldset>
        <legend>Fuzzy level</legend>
        <div id="fuzzy-slider"></div>
      </fieldset>

      <fieldset>
        <legend>Zoom</legend>
        <button id="zoom-in-btn" class="zoom-btn">+</button>
        <button id="zoom-out-btn" class="zoom-btn">-</button>
      </fieldset>

      <hr />
      <div id="footer-info">
        <span>Project by <a href="http://calebmadrigal.com">Caleb Madrigal</a> - <a href="https://github.com/calebmadrigal/truthy-graphy">View on Github</a></span>
      </div>
    </div>
  </div>
  
  <canvas id="canvas">
    Your browser does not support HTML5 Canvas.
  </canvas>
</div>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.5.1/nouislider.min.js"></script>
<script type="text/javascript">
var makeCanvasFullPage = function () {
  var canvas = document.getElementById('canvas');
  var context = canvas.getContext('2d');
  context.canvas.width  = window.innerWidth;
  context.canvas.height = window.innerHeight;
};

makeCanvasFullPage();

////////////////////////////////////////////////////////////////////////////////////  Math functions

// Returns a function maps from the inRange to the outRange
var makeLinearMapper = function(inRange, outRange, intOut) {
  var inDelta = inRange[1] - inRange[0];
  var outDelta = outRange[1] - outRange[0];
  // y = mx + b (m = slope, b = y-intersect)
  var m = (outDelta / inDelta);
  // To find b: b = y - mx
  // Just plug in first item of each range
  var b = outRange[0] - m * inRange[0];

  if (intOut) {
    var linearMapper = function(val) {
      return Math.round(m * val + b);
    }
  }
  else {
    var linearMapper = function(val) {
      return m * val + b;
    }
  }

  return linearMapper;
};

var parseEquationString = function(eq_str) {
  var split_result = eq_str.split("=");
  if (split_result.length != 2) {
    return null;
  }

  var left_eq = math.eval('f(x, y) = ' + split_result[0], {});
  var right_eq = math.eval('f(x, y) = ' + split_result[1], {});
  var error_func = function (x, y) { return Math.abs(left_eq(x, y) - right_eq(x, y)); }

  return error_func;
};

var getXMin = function (xWidth, xCenter) {
  return -1 * xWidth / 2 + xCenter;
};

var getXMax = function (xWidth, xCenter) {
  return xWidth / 2 + xCenter;
};

var getYMin = function (yWidth, yCenter) {
  return -1 * yWidth / 2 + yCenter;
};

var getYMax = function (yWidth, yCenter) {
  return yWidth / 2 + yCenter;
};

var calculateFuncForWindow = function(func, xMin, xMax, yMin, yMax, canvasWidth, canvasHeight) {
  var pixel_to_x_mapper = makeLinearMapper([0, canvasWidth], [xMin, xMax], false);
  var pixel_to_y_mapper = makeLinearMapper([canvasHeight, 0], [yMin, yMax], false);

  var minValue = 9999999;
  var maxValue = -9999999;
  var pixelValues = new Array(canvasWidth * canvasHeight);

  // Calculate values for each pixel, and find the min and max values
  for (var pixelX = 0; pixelX < canvasWidth; pixelX++) {
    for (var pixelY = 0; pixelY < canvasHeight; pixelY++) {
      var x = pixel_to_x_mapper(pixelX);
      var y = pixel_to_y_mapper(pixelY);
      var result = func(x, y);
      if (result > maxValue) {
        maxValue = result;
      }
      if (result < minValue) {
        minValue = result;
      }

      pixelValues[(pixelY * canvasWidth) + pixelX] = result;
    }
  }

  return {'pixelValues': pixelValues, 'max': maxValue, 'min': minValue};
};

////////////////////////////////////////////////////////////////////////////////// Utility Functions

var getParameterByName = function(name, url) {
  // Copied from:
  // http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
  if (!url) url = window.location.href;
  name = name.replace(/[\[\]]/g, "\\$&");
  var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
      results = regex.exec(url);
  if (!results) return null;
  if (!results[2]) return '';
  return decodeURIComponent(results[2].replace(/\+/g, " "));
};

////////////////////////////////////////////////////////////////////////////////////// Display stuff

var makeColorMapper = function(minInput, maxInput) {
    var colorChannelRange = [0, 255];
    var colorMapper = makeLinearMapper([minInput, maxInput], colorChannelRange, true);

    var mapper = function(val) {
        var colorVal = colorMapper(val);
        var rgbVals = [colorVal, colorVal, 100];
        return rgbVals;
    };

    return mapper;
};

var displayTruthyGraph = function(pixelValues, minValue, maxValue, fuzzyValue, canvasElem) {
  var context = canvas.getContext('2d');
  var canvasWidth = context.canvas.width;
  var canvasHeight = context.canvas.height;
  var imageData = context.createImageData(canvasWidth, canvasHeight);
  var pixelData = imageData.data;

  // Function to modify the value to make the graph look more interesting
  // We do this because the value is a measure of error, but we want more error
  // to look like a more intense value on the graph
  var valueModifier = function (value) {
    return Math.pow(maxValue - value, fuzzyValue);
  };

  // Determine the color scale based on the min and max values
  var colorMapper = makeColorMapper(valueModifier(maxValue), valueModifier(minValue));

  // Set the color for each pixel based on the values
  for (var x = 0; x < canvasWidth; x++) {
    for (var y = 0; y < canvasHeight; y++) {
      var value = pixelValues[y * canvasWidth + x];
      var color = colorMapper(valueModifier(value));

      // Set pixel color channels
      var pixelOffset = (canvasWidth * y + x) * 4;
      pixelData[pixelOffset] = color[0];     // red
      pixelData[pixelOffset + 1] = color[1]; // green
      pixelData[pixelOffset + 2] = color[2]; // blue
      pixelData[pixelOffset + 3] = 255;      // alpha
    }
  }

  context.putImageData(imageData, 0, 0);
};

var getHeightToWidthMultiplier = function(xWidth, yWidth) {
  return xWidth / yWidth;
};

/////////////////////////////////////////////////////////////////////////////////////////////// Main
var canvas = document.getElementById('canvas');
var context = canvas.getContext('2d');

var fuzzy_value = 20;

var xCenter = 0;
var yCenter = 0;

var yWidth = 6;
var xWidth = yWidth * getHeightToWidthMultiplier(context.canvas.width, context.canvas.height);

var xMin = getXMin(xWidth, xCenter);
var xMax = getXMax(xWidth, xCenter);
var yMin = getYMin(yWidth, yCenter);
var yMax = getYMax(yWidth, yCenter);

var recalculateWindows = function(xCenter, yCenter, yWidth) {
  // Recalculate xWidth based on yWidth
  xWidth = yWidth * getHeightToWidthMultiplier(context.canvas.width, context.canvas.height);

  // Recalculate x and y min and max based on window size and center
  xMin = getXMin(xWidth, xCenter);
  xMax = getXMax(xWidth, xCenter);
  yMin = getYMin(yWidth, yCenter);
  yMax = getYMax(yWidth, yCenter);
};

var equation_input = document.querySelector('#equation');

var getInputAndGraph = function() {
  try {
    var equationToGraph = parseEquationString(equation_input.value);
  }
  catch(err) {
    return;
  }

  if (equationToGraph) {
    var pixelValues = calculateFuncForWindow(equationToGraph, xMin, xMax, yMin, yMax,
        context.canvas.width, context.canvas.height);
    displayTruthyGraph(pixelValues['pixelValues'], pixelValues['min'], pixelValues['max'], fuzzy_value,
        document.getElementById('canvas'));
  }
};

var updateFuzzy = function(nr, val) {
  console.log(nr, val.value);
  fuzzy_value = 201 - parseInt(val.value);
	getInputAndGraph();
};

$('#fuzzy-slider').slider({
  range: "min",
  min: 1,
  max: 200,
  value: 200 - 20,
  slide: updateFuzzy,
  change: updateFuzzy
});

var zoomIn = function() {
  yWidth = yWidth * 0.833;
  recalculateWindows(xCenter, yCenter, yWidth);
  getInputAndGraph();
};

var zoomOut = function() {
  yWidth = yWidth * 1.2;
  recalculateWindows(xCenter, yCenter, yWidth);
  getInputAndGraph();
};

document.getElementById('zoom-in-btn').onclick = zoomIn;
document.getElementById('zoom-out-btn').onclick = zoomOut;

var panGraph = function(xOffsetPixels, yOffsetPixels) {
  // First, we have to convert the offset in pixels into the offset in our graphing window
  var xOffset = xOffsetPixels * (xWidth / context.canvas.width);
  var yOffset = yOffsetPixels * (yWidth / context.canvas.height);
  xCenter = xCenter - xOffset;
  yCenter = yCenter + yOffset;  // Due to flipped y, negate yOffset (and -1*-1 = 1)
  recalculateWindows(xCenter, yCenter, yWidth);
  getInputAndGraph();
};

var mouseIsDown = false;
var dragStart = {};
var dragStop = {};

canvas.onmousedown = function(e){
    dragStart.x = e.x;
    dragStart.y = e.y;
    mouseIsDown = true;
};

canvas.onmouseup = function(e){
    mouseIsDown = false;

    dragStop.x = e.x;
    dragStop.y = e.y;

    panGraph(dragStop.x - dragStart.x, dragStop.y - dragStart.y);
};

canvas.onmousemove = function(e){
    if(!mouseIsDown) return;

    dragStop.x = e.x;
    dragStop.y = e.y;
    return false;
};

window.onresize = function(event) {
  makeCanvasFullPage();
  recalculateWindows(xCenter, yCenter, yWidth);
  getInputAndGraph();
};

equation_input.addEventListener('input', getInputAndGraph);

// Try to get equation from url
var urlFragmentId = window.location.hash.substr(1);
var eqFromUrl = getParameterByName('eq', urlFragmentId);

// Initial conditions
if (eqFromUrl) {
  equation_input.value = eqFromUrl;
} else {
  equation_input.value = "y^2=x^3 - x + 1";
}

getInputAndGraph();

$("#controls").draggable({ snap: "#main" });
$("button").button();
$('input').addClass("ui-corner-all");

</script>

</body></html>
