<html><head>
  <title>Truthy Graphy</title>
</head><body>

<canvas id="canvas" width="700" height="700">
  Your browser does not support HTML5 Canvas.
</canvas>

<script type="text/javascript">

////////////////////////////////////////////////////////////////////////////////////  Math functions

// Returns a function maps from the inRange to the outRange
var makeLinearMapper = function(inRange, outRange, intOut) {
  var inDelta = inRange[1] - inRange[0];
  var outDelta = outRange[1] - outRange[0];
  // y = mx + b (m = slope, b = y-intersect)
  var m = (outDelta / inDelta);
  // To find b: b = y - mx
  // Just plug in first item of each range
  var b = outRange[0] - m * inRange[0];

  if (intOut) {
    var linearMapper = function(val) {
      return Math.round(m * val + b);
    }
  }
  else {
    var linearMapper = function(val) {
      return m * val + b;
    }
  }

  return linearMapper;
};

////////////////////////////////////////////////////////////////////////////////////// Display stuff

var makeColorMapper = function(minInput, maxInput) {
    var colorChannelRange = [0, 255];
    var colorMapper = makeLinearMapper([minInput, maxInput], colorChannelRange, true);

    var mapper = function(val) {
        var colorVal = colorMapper(val);
        var rgbVals = [colorVal, colorVal, 100];
        return rgbVals;
    };

    return mapper;
};

var displayGraph = function(func, xMin, xMax, yMin, yMax) {
  var canvas = document.getElementById('canvas');
  var context = canvas.getContext('2d');
  var canvasWidth = context.canvas.width;
  var canvasHeight = context.canvas.height;
  var imageData = context.createImageData(canvasWidth, canvasHeight);
  var pixelData = imageData.data;

  var pixel_to_x_mapper = makeLinearMapper([0, canvasWidth], [xMin, xMax], false);
  var pixel_to_y_mapper = makeLinearMapper([0, canvasHeight], [yMin, yMax], false);

  var minValue = 9999999;
  var maxValue = -9999999;
  var pixelValues = new Array(canvasWidth * canvasHeight);

  // Calculate values for each pixel, and find the min and max values
  for (var pixelX = 0; pixelX < canvasWidth; pixelX++) {
    for (var pixelY = 0; pixelY < canvasHeight; pixelY++) {
      var x = pixel_to_x_mapper(pixelX);
      var y = pixel_to_y_mapper(pixelY);
      var result = func(x, y);
      if (result > maxValue) {
        maxValue = result;
      }
      if (result < minValue) {
        minValue = result;
      }

      pixelValues[(pixelY * canvasWidth) + pixelX] = result;
    }
  }

  // Function to modify the value to make the graph look more interesting
  // We do this because the value is a measure of error, but we want more error
  // to look like a more intense value on the graph
  var valueModifier = function (value) {
    return Math.pow(maxValue+1 - value, 9);
  }

  // Determine the color scale based on the min and max values
  // TODO: make color mapper go from minValue to maxValue
  var colorMapper = makeColorMapper(valueModifier(maxValue), valueModifier(minValue));

  // Set the color for each pixel based on the values
  for (var x = 0; x < canvasWidth; x++) {
    for (var y = 0; y < canvasHeight; y++) {
      // TODO: Flip y?
      var value = pixelValues[y * canvasWidth + x];
      color = colorMapper(valueModifier(value));

      // Set pixel color channels
      var pixelOffset = (canvasWidth * y + x) * 4;
      pixelData[pixelOffset] = color[0];     // red
      pixelData[pixelOffset + 1] = color[1]; // green
      pixelData[pixelOffset + 2] = color[2]; // blue
      pixelData[pixelOffset + 3] = 255;      // alpha
    }
  }

  context.putImageData(imageData, 0, 0);
};

///////////////////////////////////////////////////////////////////////////////////////// Parameters

var xMin = -2;
var xMax = 3;
var yMin = -2.5;
var yMax = 2.5;

// Elliptic curve equation: y**2 = x**3 + ax + b
// Example curve (a=-1, b=1): y**2 = x**3 âˆ’ x + 1
var left_eq = function (x, y) { return Math.pow(y, 2); }
var right_eq = function (x, y) { return Math.pow(x, 3) - x + 1; }
var elliptic_curve = function (x, y) { return Math.abs(left_eq(x, y) - right_eq(x, y)); }

displayGraph(elliptic_curve, xMin, xMax, yMin, yMax);

</script>

</body></html>
